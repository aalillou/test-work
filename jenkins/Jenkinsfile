def registry = "http://nexus"
def dirPath = "containers"
def tagChoice = ["latest", "timestamp"]
def imagesList = []

// ImagesList from directories in containers
def getImagesList(dir) {
    sh "ls ${dir} > _list"
    def list = readFile( "_list" ).split( "\\r?\\n" ) as List;
    sh "rm -f _list"
    list = list.collect{ it.trim() }
    return list.add('Build all');
}

// Building build docker images with Kaniko
def kanikoBuildAndPush(registry, image, tag) {
    try {
        echo "Kaniko: building and pushing image: ${registry}/${image.trim()}:${tag} ... to Nexus"
    } catch(e) {
        println "kanikoBuildAndPush: Error occurred! - image: ${registry}/${image.trim()}:${tag}"
    }
}

pipeline {
    agent any

    options { 
        skipDefaultCheckout()
        timeout(time: 45, unit: 'MINUTES')
    }

    stages {
        stage('Checkout code') {
            steps {
                checkout scm
            }
        }
        stage('Select image and tag to build and push to registry') {
            steps {
                script {
                    imagesList = getImagesList(dirPath)
                    image = input message: "Select image (Dockerfile)", parameters: [choice(name: "image", choices: imagesList)]
                    tag = input message: "Select tag (latest)", parameters: [choice(name: "tag", choices: tagChoice)]
                    tag = tag != 'timestamp' ? tag : new Date().getTime()/1000 as Integer 

                    if (image != 'Build all') kanikoBuildAndPush (registry, image, tag) // <- Selected build
                    else {                                                              // <-- Selected build all
                        echo 'LOOPING - kanikoBuildAndPush'
                        try { 
                            imagesList[0..-2].each{ image -> // remove 'Build all' from list and loop
                                kanikoBuildAndPush (registry, image, tag)
                            }
                        } catch(e) {
                            println "Error occurred! LOOPING - kanikoBuildAndPush - image: ${registry}/${image}:${tag}"
                        }
                    }
                }
            }
        }
    }
}
